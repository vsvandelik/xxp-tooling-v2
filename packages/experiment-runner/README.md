# ExtremeXP Experiment Runner

The `@extremexp/experiment-runner` package provides a robust execution engine for running ExtremeXP experiments from generated artifacts. It handles experiment lifecycle management, progress tracking, state persistence, and resumption capabilities.

## Overview

This package implements the core experiment execution logic for the ExtremeXP platform. It takes JSON artifacts (generated by the `artifact-generator`) and executes them with full support for:

- **State Persistence**: SQLite-based storage for experiment runs and task execution history
- **Resume Capability**: Ability to resume interrupted experiments from their last checkpoint
- **Progress Tracking**: Real-time progress updates with customizable callbacks
- **User Interaction**: Support for experiments requiring user input during execution
- **Concurrent Execution**: Task-level parallelism within experiment spaces
- **Error Handling**: Comprehensive error reporting and recovery mechanisms

## Architecture

### Core Components

#### ExperimentExecutor
The main execution engine that orchestrates experiment runs:

```typescript
import { ExperimentExecutor } from '@extremexp/experiment-runner';

const executor = new ExperimentExecutor('./experiments.db');
await executor.run('/path/to/artifact.json', {
  resume: true,
  progressCallback: {
    onProgress: (progress, message) => {
      console.log(`${(progress * 100).toFixed(1)}% - ${message}`);
    }
  }
});
```

#### Database Repository
Provides persistent storage for experiment state and history:

- **SqliteRepository**: Default SQLite implementation
- **DatabaseRepository**: Abstract interface for custom storage backends

#### Space and Task Executors
Handle the execution of individual experiment components:

- **SpaceExecutor**: Manages parameter space execution and task orchestration
- **TaskExecutor**: Executes individual tasks with input/output handling

#### Progress System
Comprehensive progress tracking with multiple callback types:

```typescript
const progressCallback = {
  onTaskStart: (taskId, params) => console.log(`Starting ${taskId}`),
  onTaskComplete: (taskId, params, outputs) => console.log(`Completed ${taskId}`),
  onSpaceStart: (spaceId) => console.log(`Starting space ${spaceId}`),
  onSpaceComplete: (spaceId) => console.log(`Completed space ${spaceId}`),
  onProgress: (progress, message) => console.log(`${progress * 100}% - ${message}`),
  onError: (error, context) => console.error('Error:', error)
};
```

## Installation

```bash
npm install @extremexp/experiment-runner
```

## Usage

### Basic Execution

```typescript
import { ExperimentExecutor } from '@extremexp/experiment-runner';

async function runExperiment() {
  const executor = new ExperimentExecutor();
  
  const result = await executor.run('./my-experiment.json', {
    progressCallback: {
      onProgress: (progress, message) => {
        console.log(`Progress: ${(progress * 100).toFixed(1)}% - ${message}`);
      }
    }
  });
  
  console.log('Experiment completed:', result.status);
  console.log('Outputs:', result.outputs);
}
```

### Resuming Experiments

```typescript
// Resume a previously interrupted experiment
const result = await executor.run('./my-experiment.json', {
  resume: true,
  progressCallback: {
    onProgress: (progress, message) => {
      console.log(`Resuming: ${(progress * 100).toFixed(1)}% - ${message}`);
    }
  }
});
```

### Handling User Input

```typescript
import { ConsoleInputProvider } from '@extremexp/experiment-runner';

const result = await executor.run('./interactive-experiment.json', {
  userInputProvider: new ConsoleInputProvider(),
  progressCallback: {
    onProgress: (progress, message) => console.log(`${progress * 100}% - ${message}`)
  }
});
```

### Custom Input Provider

```typescript
import { UserInputProvider } from '@extremexp/experiment-runner';

class WebInputProvider implements UserInputProvider {
  async getInput(prompt: string): Promise<string> {
    // Custom implementation (e.g., web interface, API call)
    return await this.getInputFromWeb(prompt);
  }
  
  private async getInputFromWeb(prompt: string): Promise<string> {
    // Implementation details...
    return 'user response';
  }
}

const result = await executor.run('./experiment.json', {
  userInputProvider: new WebInputProvider()
});
```

### Monitoring Experiment Status

```typescript
// Get current status of a running experiment
const status = await executor.getStatus('MyExperiment', '1.0');

if (status) {
  console.log('Status:', status.status);
  console.log('Progress:', status.progress);
  console.log('Current Space:', status.currentSpace);
}
```

### Terminating Experiments

```typescript
// Gracefully terminate a running experiment
const terminated = await executor.terminate('MyExperiment', '1.0');
console.log('Terminated:', terminated);
```

## Artifact Structure

The experiment runner expects JSON artifacts with the following structure:

```json
{
  "experiment": "MyExperiment",
  "version": "1.0",
  "tasks": [
    [
      {
        "taskId": "task1",
        "name": "Data Processing",
        "executable": "python",
        "arguments": ["process.py"],
        "inputData": ["input_file"],
        "outputData": ["result_file"]
      }
    ]
  ],
  "spaces": [
    {
      "spaceId": "space1",
      "parameters": [
        {
          "input_file": "/data/dataset1.csv",
          "param1": "value1"
        }
      ],
      "tasksOrder": ["task1"]
    }
  ],
  "control": {
    "START": "space1",
    "transitions": [
      {
        "from": "space1",
        "to": "END",
        "condition": "always"
      }
    ]
  }
}
```

## Database Schema

The runner uses SQLite for persistence with the following key tables:

- **runs**: Experiment run metadata and status
- **task_executions**: Individual task execution records
- **data_mappings**: Input/output data mappings
- **control_state**: Control flow state for resumption

## Extension Points

### Custom Repository Implementation

```typescript
import { DatabaseRepository } from '@extremexp/experiment-runner';

class CustomRepository implements DatabaseRepository {
  async initialize(): Promise<void> {
    // Custom initialization
  }
  
  async createRun(run: RunRecord): Promise<void> {
    // Custom run creation
  }
  
  // Implement other required methods...
}

const executor = new ExperimentExecutor(new CustomRepository());
```

### Custom Progress Callbacks

```typescript
interface CustomProgressCallback extends ProgressCallback {
  onSpaceProgress?: (spaceId: string, progress: number) => void;
  onTaskProgress?: (taskId: string, progress: number) => void;
}

// Implement custom progress tracking
```

## Error Handling

The runner provides comprehensive error handling:

```typescript
try {
  const result = await executor.run('./experiment.json');
} catch (error) {
  if (error.message.includes('Artifact validation failed')) {
    console.error('Invalid artifact:', error);
  } else if (error.message.includes('Task execution failed')) {
    console.error('Task failed:', error);
  } else {
    console.error('Unexpected error:', error);
  }
}
```

## Performance Considerations

- **Database Connection**: Reuse executor instances for multiple runs to avoid connection overhead
- **Task Concurrency**: Tasks within the same group can execute in parallel
- **Memory Usage**: Large artifacts and datasets may require memory optimization
- **Progress Callbacks**: Avoid heavy processing in progress callbacks to prevent blocking

## Debugging

Enable detailed logging for troubleshooting:

```typescript
// The runner logs important events to console
// For custom logging, implement custom progress callbacks
const result = await executor.run('./experiment.json', {
  progressCallback: {
    onProgress: (progress, message) => {
      console.log(`[${new Date().toISOString()}] ${progress * 100}% - ${message}`);
    },
    onError: (error, context) => {
      console.error(`[${new Date().toISOString()}] Error in ${context}:`, error);
    }
  }
});
```

## API Reference

### Main Classes

- **ExperimentExecutor**: Main execution engine
- **SqliteRepository**: SQLite database implementation
- **ConsoleInputProvider**: Console-based user input provider
- **SpaceExecutor**: Space execution management
- **TaskExecutor**: Task execution management

### Key Interfaces

- **ExperimentRunner**: Main runner interface
- **DatabaseRepository**: Storage abstraction
- **UserInputProvider**: User input abstraction
- **ProgressCallback**: Progress event interface

### Type Definitions

- **Artifact**: Complete experiment definition
- **RunResult**: Execution result with status and outputs
- **RunStatus**: Current experiment status and progress
- **Task**: Individual task definition
- **Space**: Parameter space definition

For detailed API documentation, see the TypeDoc-generated documentation.